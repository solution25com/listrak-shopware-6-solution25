{% if config('Listrak.config.merchantId') and config('Listrak.config.enableListrakTracking') %}
    {% set merchantId = config('Listrak.config.merchantId') %}
    {% set placement = placement | default('base') %}
    {% set cartLink = path('frontend.checkout.cart.page') %}
    {% if page.extensions.listrakCartRecreate is defined and page.extensions.listrakCartRecreate.link %}
        {% set cartLink =  page.extensions.listrakCartRecreate.link %}
    {% endif %}

    {% set payloadData = {
        cartLink: cartLink,
        placement: placement,
        email: context.customer.email | default(''),
        firstName: context.customer.firstName | default(''),
        lastName: context.customer.lastName | default(''),
        currencyIsoCode: context.currency.isoCode | default(''),
        currencyFactor: context.currency.factor | default(''),
        usdCurrency: page.extensions.listrakInfo.usdCurrency | default('')
    } %}
    {% if placement == 'order' %}

        {% set cartObject = page.order %}

        {% set discountTotal = 0 %}
        {% set processedLineItems = [] %}

        {% for lineItem in cartObject.lineItems %}
            {% if lineItem.type == "promotion" %}
                {% set discountTotal = discountTotal + lineItem.price.totalPrice %}
                {% set sku = 'PROMOTION_ITEM_'  ~ lineItem.id %}
            {% elseif lineItem.type == 'container' %}
                {% set sku = 'CONTAINER_ITEM_'  ~ lineItem.id %}
            {% elseif lineItem.type == 'custom' %}
                {% set sku = 'CUSTOM_ITEM_'  ~ lineItem.id %}
            {% elseif lineItem.type == 'custom' %}
                {% set sku = 'CREDIT_ITEM_'  ~ lineItem.id %}
            {% elseif lineItem.type == 'custom' %}
                {% set sku = 'DISCOUNT_ITEM_'  ~ lineItem.id %}
            {% elseif lineItem.type == 'product' %}
                {% set sku = lineItem.payload.productNumber | default('PRODUCT_ITEM_' ~ lineItem.id ) %}
            {% else %}
                {% set sku = 'CUSTOM_ITEM_'  ~ lineItem.id %}
            {% endif %}

            {% set unitPrice = lineItem.price.listPrice and lineItem.price.listPrice.price > lineItem.price.unitPrice ?
                lineItem.price.listPrice.price :
                lineItem.price.unitPrice %}

            {% set imageUrl = lineItem.cover.url | default('') %}
            {% set productUrl = seoUrl('frontend.detail.page', {'productId': lineItem.id}) %}
            {% set productData = {
                sku: sku,
                name: lineItem.label,
                quantity: lineItem.quantity,
                price: unitPrice,
                totalPrice: lineItem.price.totalPrice,
                imageUrl: imageUrl,
                productUrl: productUrl | default('')
            } %}

            {% set processedLineItems = processedLineItems|merge([productData]) %}

        {% endfor %}

        {% set taxTotal = 0 %}
        {% for item in cartObject.price.calculatedTaxes %}
            {% set taxTotal = taxTotal + item.tax %}
        {% endfor %}


        {% set shippingTotal = 0 %}
        {% for item in cartObject.deliveries %}
            {% set shippingTotal = shippingTotal + item.shippingCosts.totalPrice %}
        {% endfor %}

        {% set itemTotal = 0 %}
        {% for item in cartObject.lineItems %}
            {% set itemTotal = itemTotal + item.price.totalPrice %}
        {% endfor %}

        {% set payloadData = payloadData|merge({
            orderNumber: page.order.orderNumber,
            shippingTotal: shippingTotal,
            taxTotal: taxTotal,
            itemTotal: itemTotal,
            orderTotal: cartObject.price.totalPrice | default(0),
            lineItems: processedLineItems
        }) %}

    {% endif %}

    {% set listrakTrackingOptions = {
        merchantId: merchantId,
        requiresCookieConsent: requiresCookieConsent,
        data: payloadData | default('')
    } %}

    <template data-listrak-tracking
              data-listrak-tracking-options='{{ listrakTrackingOptions|json_encode }}'></template>
{% endif %}
